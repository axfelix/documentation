---
id: durable-execution
title: Go SDK developer's guide - Durable Execution
sidebar_label: Develop for durability
sidebar_position: 3
description: The Durable Execution section of the Temporal Developer's guide covers advanced beginner concepts for working with Temporal, including testing your code, reviewing workflow event history, adding timers, and understanding determinism. Developing for durable execution is a core aspect of Temporal.
slug: /dev-guide/go/durable-execution
toc_max_heading_level: 4
keywords:
- determinism
- developer-guide-doc-type
- durable execution
- event history
- go sdk
- introduction-doc-type
- replay
- replay test
- replayer
- testing
tags:
- determinism
- developer-guide-doc-type
- durable-execution
- event-history
- go-sdk
- introduction-doc-type
- replay
- replay-test
- replayer
- testing
---

<!-- THIS FILE IS GENERATED. DO NOT EDIT THIS FILE DIRECTLY -->

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

When it comes to the Temporal Platform's ability to durably execute code, the SDK's ability to [Replay](/dev-guide/sdks#replays) a Workflow Execution is a major aspect of that.
This chapter introduces the development patterns which enable that.

:::competency Develop for a Durable Execution

This chapter of the Temporal Go SDK developer's guide introduces best practices to developing deterministic Workflows that can be Replayed, enabling a Durable Execution.

By the end of this section you will know basic best practices for Workflow Definition development.

Learning objectives:

- Identify SDK API calls that map to Events
- Recognize non-deterministic Workflow code
- Explain how Workflow code execution progresses

The information in this chapter is also available in the [Temporal 102 course](https://learn.temporal.io/courses/temporal_102/)

:::

This chapter builds on the [Construct a new Temporal Application project](/dev-guide/go/project-setup#) chapter and relies on the Background Check use case and sample applications as a means to contextualize the information.

This chapter walks through the following sequence:

- Retrieve a Workflow Execution's Event History
- Add a Replay test to your application
- etc...
- TODO

## Retrieve a Workflow Execution's Event History {#retrieve-event-history}

There are a few ways to view and download a Workflow Execution's [Event History](/workflows#event-history).
We recommend starting off by using either the Temporal CLI or the Web UI to access it.

### Via Temporal CLI

Use the Temporal CLI's `temporal workflow show` command to save your Workflow Execution's Event History to a local file.
Run the command from the `/tests` directory so that the file saves alongside the other testing files.

```text
/backgroundcheck
    ...
    /tests
        | tests.go
        | backgroundcheck_workflow_history.json
```

**Local dev server**

If you have been following along with the earlier chapters of this guide, your Workflow Id might be something like "backgroundcheck_workflow".

```shell
temporal workflow show \
 --workflow-id backgroundcheck_workflow \
 --namespace backgroundcheck_namespace \
 --output json > backgroundcheck_workflow_event_history.json
```

:::info Workflow Id returns the most recent Workflow Execution

The most recent Event History for that Workflow Id is returned when you only use the Workflow Id to identify the Workflow Execution.
Use the `--run-id` option as well to get the Event History of an earlier Workflow Execution by the same Workflow Id.

:::

If you don't specify an output file, the CLI provides an overview of the Workflow Execution's History, that would look something like this:

```shell
Progress:
  ID          Time                     Type
   1  2023-10-25T20:28:03Z  WorkflowExecutionStarted
   2  2023-10-25T20:28:03Z  WorkflowTaskScheduled
   3  2023-10-25T20:28:03Z  WorkflowTaskStarted
   4  2023-10-25T20:28:03Z  WorkflowTaskCompleted
   5  2023-10-25T20:28:03Z  ActivityTaskScheduled
   6  2023-10-25T20:28:03Z  ActivityTaskStarted
   7  2023-10-25T20:28:03Z  ActivityTaskCompleted
   8  2023-10-25T20:28:03Z  WorkflowTaskScheduled
   9  2023-10-25T20:28:03Z  WorkflowTaskStarted
  10  2023-10-25T20:28:03Z  WorkflowTaskCompleted
  11  2023-10-25T20:28:03Z  WorkflowExecutionCompleted

Result:
  Status: COMPLETED
  Output: ["pass"]
```

**Temporal Cloud**

For Temporal Cloud, remember to either provide the paths to your certificate and private keys as command options, or set those paths as environment variables:

```shell
temporal workflow show \
 --workflow-id backgroundcheck_workflow \
 --namespace backgroundcheck_namespace \
 --tls-cert-path /path/to/ca.pem \
 --tls-key-path /path/to/ca.key \
 --output json  > backgroundcheck_workflow_history.json
```

**Self-hosted Temporal Cluster**

For Self-hosted environments, you might be using the Temporal CLI command alias:

```shell
temporal_docker workflow show \
 --workflow-id backgroundcheck_workflow \
 --namespace backgroundcheck_namespace \
 --output json  > backgroundcheck_workflow_history.json
```

### Via the UI

A Workflow Execution's Event History is also available in the Web UI.

Navigate to the Workflows page in the UI and select the Workflow Execution.

<div class="tdiw"><div class="tditw"><p class="tdit">Select a Workflow Execution from the Workflows page</p></div><div class="tdiiw"><img class="img_ev3q" src="/img/select-workflow-execution-in-ui.png" alt="Select a Workflow Execution from the Workflows page" height="870" width="3012" /></div></div>

From the Workflow details page you can copy the Event History from the JSON tab and paste it into the `backgroundcheck_workflow_history.json` file.

<div class="tdiw"><div class="tditw"><p class="tdit">Copy Event History JSON object from the Web UI</p></div><div class="tdiiw"><img class="img_ev3q" src="/img/copy-events-from-workflow-details-page.png" alt="Copy Event History JSON object from the Web UI" height="768" width="2822" /></div></div>

## Add a Replay test {#add-replay-test}

<!-- DO NOT EDIT THIS FILE DIRECTLY.
THIS FILE IS GENERATED from https://github.com/temporalio/documentation-samples-go/blob/port_replay_test_dacx/backgroundcheck_replay/tests/backgroundcheck_test.go. -->

Add the Replay test to the set of application tests.
The Replayer is available from the Worker package in the SDK.
Register the Workflow Definition and then specify an existing Event History to compare to.

Run the tests in the test directory (`go test`).
If the Workflow Definition and the Event History are incompatible then the test fails.

:::copycode Sample application code

The following code sample comes from a working and tested sample application.
The code sample might be abridged within the guide to highlight key aspects.
Visit the source repository to [view the source code](https://github.com/temporalio/documentation-samples-go/blob/port_replay_test_dacx/backgroundcheck_replay/tests/backgroundcheck_test.go) in the context of the rest of the application code.

:::

```go
// TestReplayWorkflowHistoryFromFile tests for Event History compatability.
func (s *UnitTestSuite) TestReplayWorkflowHistoryFromFile() {
	// Create a new Replayer
	replayer := worker.NewWorkflowReplayer()
	// Register the Workflow with the Replayer
	replayer.RegisterWorkflow(workflows.BackgroundCheck)
	// Compare the current Workflow code against the existing Event History
	err := replayer.ReplayWorkflowHistoryFromJSONFile(nil, "backgroundcheck_workflow_event_history.json")
```

### Why add a Replay test? {#why-replay-test}

The Replay test is important because it verifies whether the current Workflow code (Workflow Definition) remains compatible with the Event Histories of earlier Workflow Executions.

A failed Replay test typically indicates that the Workflow code exhibits non-deterministic behavior.
In other words, for a specific input, the Workflow code can follow different code paths during each execution, resulting in distinct sequences of Events.
The Temporal Platform's ability to ensure durable execution depends on the SDK's capability to re-execute code and return to the most recent state of the code's execution.

The Replay test executes the same steps as the SDK and verifies compatibility.

Workflow code becomes non-deterministic primarily through two main avenues.

1. **Code changes:** When you change your Workflow code and deploy those changes while there are still active Workflow Executions relying on older code versions.

2. **Bad branching logic:**: This occurs when branching logic within the Workflow is determined by factors beyond the SDK's control."

## Non-deterministic code changes {#durability-through-replays}

The most important thing to remember from this section is to have an application versioning plan whenever you are developing and maintaining a Temporal Application that will eventually deploy to a production environment.

We cover versioning APIs and versioning strategies in other parts of the dev guide, this chapter is dedicated to explaining the fundamentals so that you understand why and how to approach those strategies.

<!--TODO ^ update with links to those places -->

### The Event History

Let's inspect the Event History of one the recent backgroundcheck Workflows using the `temporal workflow show` command:

```shell
temporal workflow show \
 --workflow-id backgroundcheck_workflow \
 --namespace backgroundcheck_namespace
```

You will see output similar to this:

```shell
Progress:
  ID          Time                     Type
   1  2023-10-25T20:28:03Z  WorkflowExecutionStarted
   2  2023-10-25T20:28:03Z  WorkflowTaskScheduled
   3  2023-10-25T20:28:03Z  WorkflowTaskStarted
   4  2023-10-25T20:28:03Z  WorkflowTaskCompleted
   5  2023-10-25T20:28:03Z  ActivityTaskScheduled
   6  2023-10-25T20:28:03Z  ActivityTaskStarted
   7  2023-10-25T20:28:03Z  ActivityTaskCompleted
   8  2023-10-25T20:28:03Z  WorkflowTaskScheduled
   9  2023-10-25T20:28:03Z  WorkflowTaskStarted
  10  2023-10-25T20:28:03Z  WorkflowTaskCompleted
  11  2023-10-25T20:28:03Z  WorkflowExecutionCompleted

Result:
  Status: COMPLETED
  Output: ["pass"]
```

The preceding output shows eleven Events in the Event History ordered in a particular sequence.
All Events are created by the Temporal Server in response to either a request coming from a Temporal Client, or a [Command](/workflows#command) coming from the Worker.

:::info Event reference

The [Event reference](/references/events#) serves as a source of truth for all possible Events in the Workflow Execution Event History.

:::

Let's change the Workflow code to see how this affects the Event History.

### Examples of Changes That May Lead to Non-Deterministic Errors

- Adding or removing an Activity
- Switching the Activity Type used in a call to `ExecuteActivity`
- Adding or removing a Timer
- Altering the execution order of Activities or Timers relative to one another

### Examples of Changes That Do Not Lead to Non-Deterministic Errors

- Modifying statements in a Workflow Definition, such as logging statements, that do not affect the Commands generated during Workflow Execution
- Changing attributes in a `ActivityOptions` or `RetryPolicy`
- Modifying code inside of an Activity Definition

## Non-deterministic branching logic {#durability-through-replays}

Also referred to as "intrinsic non-determinism", writing bad branching logic in Workflow code prevents the Workflow code from executing to completion because the Workflow can have a different code path than the one expected from the Event History.

### Common Sources of Non-Determinism

- Using Random numbers
- Accessing / Mutating External Systems or State (do this in Activities, not Workflows)
- Relying on System Time (use [Workflow.now()](https://pkg.go.dev/go.temporal.io/sdk/workflow#Now) instead)
- Working Directly with Threads or Goroutines (use [Workflow.go()](https://pkg.go.dev/go.temporal.io/sdk/workflow#Go) instead)
- Iterating over Data Structures with Unknown Ordering
- Storing or Evaluating the [Run ID](https://docs.temporal.io/workflows#run-id)

### Demonstrating a Non-Deterministic Error

To produce a Non-Deterministic Error following the example in this section, you can add a random number generator and a `time.Sleep` call — two things you should never do in a Temporal Workflow.

Add `"math/rand"` to the list of imported packages at the start of `your_workflow_definition_dacx.go`, and add `time.Sleep(time.Duration(rand.Intn(10)) * time.Second)` to line 68, just after `ctx = workflow.WithActivityOptions(ctx, activityOptions)`:

```go
import (
	"time"
	"math/rand"
	"go.temporal.io/sdk/workflow"
)

...

	ctx = workflow.WithActivityOptions(ctx, activityOptions)
	time.Sleep(time.Duration(rand.Intn(10)) * time.Second)
	activityParam := YourActivityParam{
		ActivityParamX: param.WorkflowParamX,
		ActivityParamY: param.WorkflowParamY,
	}
```

Save the file, then re-run both the Worker Process and the HTTP server as before:

```shell
go run worker/main_dacx.go
go run gateway/main_dacx.go
```

Once both the Worker process and the HTTP server are running, access `http://localhost:8091/start` using either your browser or `curl`. It will not return any output to the browser or cURL command. Reload the page or re-run cURL at least twice to ensure that the Temporal Cluster catches the non-deterministic behavior that you've added.

Next, you can reopen the Temporal [Web UI](http://localhost:8233/) to find a problem with your Workflow:

<div class="tdiw"><div class="tditw"><p class="tdit">Web UI view of a non-determinism error</p></div><div class="tdiiw"><img class="img_ev3q" src="/img/deterministic-failure.png" alt="Web UI view of a non-determinism error" height="335" width="943" /></div></div>

Use the `temporal workflow show` command again to retrieve the Workflow Event History:

```shell
temporal workflow show --workflow-id your-workflow-id --output json  > your_workflow_history.json
```

This Workflow output contains a `WorkflowTaskFailed` event, which will fail the `TestReplayWorkflowHistoryFromFile()` test:

```output
{
  "eventId": "4",
  "eventTime": "2023-10-16T22:02:33.225671800Z",
  "eventType": "WorkflowTaskFailed",
  "taskId": "1048672",
  "workflowTaskFailedEventAttributes": {
    "scheduledEventId": "2",
    "startedEventId": "3",
    "cause": "WorkflowWorkerUnhandledFailure",
```

Testing for Non-Determinism errors can help improve your Temporal Workflows. You can also watch [Using Workflow Reset to Recover from a Bad Deployment](https://www.youtube.com/embed/wKnGbukEppI?rel=0&iv_load_policy=3&modestbranding=1&showsearch=0&showinfo=0&wmode=transparent) from our [Temporal 102](https://learn.temporal.io/courses/temporal_102/go) course.

### Wrapped Language Primitives

The Temporal Go SDK provides wrappers around some Go language primitives — `time.Sleep()` and `time.Now()` — so you can safely use them within Temporal Workflows.

Use [workflow.Sleep()](https://pkg.go.dev/go.temporal.io/sdk/workflow#Sleep) to pause a Workflow. Unlike `time.Sleep()`, `workflow.Sleep()` requires you to pass the Workflow `Context` as an additional argument. It also allows you to programmatically cancel a pending sleep, and to automatically advance past a sleep duration when testing.

Use [workflow.Now()](https://pkg.go.dev/go.temporal.io/sdk/workflow#Now) to returns the current time when the workflow task is started or replayed. Workflows must use this Now() to get the wall clock time.
